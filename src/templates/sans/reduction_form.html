 {% extends "base.html" %}
 
 {% load staticfiles %}

 {% load crispy_forms_tags %}
 
 {% block header %}
	{{ block.super }}
	<!-- handsontable -->
	<link rel="stylesheet" type="text/css" href='{% static "thirdparty/handsontable/handsontable.full.min.css" %}'>
<style>
.ui-tooltip { 
    overflow: visible;
}
.ui-tooltip-content { 
    overflow: visible;
}
.ui-draggable {
    cursor: pointer;
    background: transparent;
}

.ui-draggable-dragging {
    position: relative;
    z-index: 1000000000;
}
</style>
{% endblock %}

 
{% block breadcrumbs %}
<div class="container">
    <ol class="breadcrumb">
        <li><a href="{% url 'index' %}">Home</a></li>
        <li><a href="{% url 'sans:reduction_list' %}">Reduction</a></li>
        <li class="active">{%if object %}{{object}}{% else %} new {% endif%}</li>
    </ol>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="page-header">
        <h1>Reduction<small> new</small></h1>
    </div>

    <div class="row">
        <div class="col-md-9">
            <form method="post" action="" class="form-horizontal" onsubmit="return populateFormWithHotContents();">
                {{ formset.management_form }}
                <div class="well">
                    <div class="panel-body">
                        {% crispy form  %}
                    </div>
                </div>

                <hr />
                
                <div class="well">
                    <div class="panel-body">
                        <ul class="nav nav-tabs nav-justified">
                        {% for f in formset %}
                            <li class="{{ forloop.first|yesno:'active,'}}"><a data-toggle="tab" href="#tab{{forloop.counter}}">Region {{forloop.counter}}</a>
                            </li>
                        {% endfor %}
                        </ul>
                        <div class="tab-content">
                        {% for f in formset %}
                            <div id="tab{{forloop.counter}}" class="tab-pane fade{{ forloop.first|yesno:' in active,'}}">
                                {% crispy f f.helper %}
                                <div class="help-block"></div><!-- vertical spaces -->
                                <a href="#" class="btn btn-default" role="button" data-toggle="tooltip" title="Click to auto-populate the spreadsheet with info from ICat">Populate from ICat</a>
                            </div>
                        {% endfor %}
                        </div>
                    </div>
                </div>

                <hr />

                <button type="submit" class="btn btn-primary">Save</button>
                <button type="cancel" class="btn btn-default" onclick="window.history.back()" >Cancel</button>

            </form>
        </div>
        <!-- File List collumn -->
        <div class="col-md-3">
            <div class="panel panel-default">
                <div class="panel-heading">Files for: <strong>{{user.profile.ipts}}</strong> {%if user.profile.experiment_number and user.profile.experiment_number > 0%} / <strong>exp {{user.profile.experiment_number}} </strong> {% endif %} </div>
                <div class="panel-body">
                    <table id="icat_table" class="display table table-striped table-hover" cellspacing="0" width="100%">
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block footer_js%}
{{ block.super }}
<script src='{% static "thirdparty/DataTables/datatables.min.js" %}'></script>
<script src='{% static "thirdparty/handsontable/handsontable.full.min.js" %}'></script>
<!-- page script -->
<script>

/******************* handsontable *************************/

// Let's get the entries: id_regions-0-entries
var entriesSelectors = $('[id ^=id_regions][id $=entries]');

// For every input field add a div anchor to place the spreadsheet
$.each( entriesSelectors, function( i, selector ) {
    var data =  JSON.parse(selector.value);
    // Add the anchor: <div id="hot-?" />
    var $div = $("<div>", {id: "hot-" + i, class: "hot handsontable" });
    $div.insertAfter( selector );
    //console.log(data);
    var options = {
        data: data,
        height: 300,
        minSpareRows: 10,
        stretchH: 'all',
        columnSorting: true,
        contextMenu: true,
        autoWrapRow: true,
        rowHeaders: true,
        colHeaders: {{entry_headers | safe}},
        contextMenu: true,
        outsideClickDeselects: false,
        formulas: true,
        manualColumnResize: true
    };
    $div.handsontable(options);
});

/*
 Let's map the spreasheet contents into the form entries field
 */
function populateFormWithHotContents() {
    // the selectors are ordered by the order they are in the DOM
    // entries are first, hot are after
    var hotSelectors = $('[id ^=hot-],[id ^=id_regions][id $=entries]');
    for(i = 0; i < hotSelectors.length; i=i+2) {
        //console.log(hotSelectors[i]);
        var hotContents = JSON.stringify($(hotSelectors[i+1]).handsontable('getData'));
        $(hotSelectors[i]).val(hotContents);
    }
    return true;
};


/*
 This will re-render the spreadsheet on the visible tab!
 */
$('.nav-tabs a').on('shown.bs.tab', function(event){
//     console.log($(event.target).text());         // active tab
//     console.log($(event.relatedTarget).text());  // previous tab
    $(event.target.hash + ' div.handsontable').handsontable('render');
});

/****** ICAT TABLE ************/
var dataSet = [{% for run in runs %}["{{run.filename}}", '{{run.metadata.scan_type}}', {{run.thumbnails | safe}} ]
    {% if not forloop.last and not runs.count == 1 %},{% endif %}{% endfor %}];


    $(document).ready(function () {
        $('#icat_table').DataTable({
            data: dataSet,
            //dom: '<"top"i>rt<"bottom"flp><"clear">',
            columns: [{
                title: "Title",
                render: function (data, type, row, meta) {
                    // Let's see how many thumbnails we have:
                    var p = row[2];
                    var thumbs_html = "";
                    for (var key in p) {
                        if (p.hasOwnProperty(key)) {
                            //console.log(key);
                            thumbs_html += '<img alt=\'' + key + '\' src=\'data:image/png;base64,' + p[key] + '\' /><p>' + key +'</p>';
                        }
                    }
                    return '<a data-toggle="tooltip" title="' +
                        //'<img src=\'data:image/png;base64,' + row[2] + '\' />'  +
                        thumbs_html +
                        '<p>' + data + '</p>' +
                        '<ul>  <li>Metdata 0</li><li>Metdata 1</li><li>Metdata 123</li></ul>' +
                        '">' +
                        '<span class="glyphicon glyphicon-film" aria-hidden="true"></span>&nbsp;</a>' + data;
                }
            },
            {
                title: "Type"
            },
            {
                title: "Image",
            }
            ],
            "columnDefs": [
                {
                    "targets": [1],
                    "visible": false,
                    "searchable": true
                },
                {
                    "targets": [2],
                    "visible": false,
                    "searchable": false
                }
            ],
            "order": [
                [0, 'asc']
            ],
            //"lengthMenu": [
            //    [10, 20, 50, -1],
            //    [10, 20, 50, "All"]
            //],
            //"pageLength": 20,
            //"paging": true,
            "scrollY":        "800px",
            "scrollCollapse": true,
            "paging":         false,
            "lengthChange": true,
            "searching": true,
            "ordering": true,
            "info": true,
            "autoWidth": true,
            "bInfo" : false, // hide "Showing x on n"
            initComplete: function () {
                var api = this.api();
                var titles = api.column(0);
                var types = api.column(1);

                var select = $('<select class="form-control"><option value=""></option></select>')
                    .appendTo($(titles.header()).empty())
                    .on('change', function () {
                        var val = $.fn.dataTable.util.escapeRegex(
                            $(this).val()
                        );
                        types.search(val ? '^' + val + '$' : '', true, false).draw();
                        set_tooltip_as_image();
                    });
                // populates the drop down
                types.data().unique().sort().each(function (d, j) {
                    select.append('<option value="' + d + '">' + d + '</option>')
                });
                //set_tooltip_as_image();

                $(this.fnGetNodes()).draggable({
                    revert: 'invalid',
                    helper: 'clone',
                    appendTo: 'body'
                });
            },
            "fnDrawCallback": function (oSettings) {
                // When table is redrawn!! E.g. page changes
                set_tooltip_as_image();
            },
        })
    });

    function set_tooltip_as_image() {
        // Tool tip options
        $('#icat_table a[data-toggle="tooltip"]').tooltip({
            animated: 'fade',
            placement: 'left',
            html: true,
            container: 'body' // To avoid tooltip clipping by the container overflow:auto
        });
    }


/**** let's Make the spreasheet droppable */

// All handsomtables starting with id hot
$("[id^='hot']").droppable({
    accept: ".ui-draggable",
    drop: function (event, ui) {
        // Get a reference to this handsontable instance
        var ht = $(this).handsontable('getInstance');
        // Hide the helper, so that we can use .elementFromPoint
        // to grab the item beneath the cursor by coordinate
        ui.helper.hide();
        var $destination = $(document.elementFromPoint(event.clientX, event.clientY));
        var $cell = $destination.closest('td');

        // Grab the parent tr, then the parent tbody so that we
        // can use their index to find the row and column of the
        // destination object
        var $tr = $destination.closest('tr');
        var $tbody = $tr.closest('tbody');

        //var col = $tr.children().index($destination);
        var col = $cell.index() - 1;
        var row = $tbody.children().index($tr);

        // Use the setDataAtCell method, which takes a row and
        // col number, to adjust the data 
        console.log("Setting i,j:", row, col, "with value = ", ui.draggable.val())
        if (row >= 0 && col >= 0)
            ht.setDataAtCell(row, col, ui.draggable.text());
        $cell.css("background-color", "yellow");
    },
    over: function (event, elem) {
        $(this).addClass("over");
    },
    out: function (event, elem) {
        $(this).removeClass("over");
    }
});

</script>
{# This is for django-autocomplete-light:  jquery is loaded before #}
{{ form.media }}

{% endblock %}
